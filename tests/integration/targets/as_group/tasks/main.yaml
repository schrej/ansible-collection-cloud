---
- module_defaults:
    loadbalancer:
      cloud: "{{ test_cloud }}"
  block:
    - name: Set random prefix
      set_fact:
        prefix: "{{ 99999999 | random | to_uuid | hash('md5') }}"

    - name: Set initial facts
      set_fact:
        config_name: "{{ ( prefix + '_config') }}"
        key_name: "{{ ( prefix + '_key') }}"

    - name: Create keypair
      openstack.cloud.os_keypair:
          name: "{{ key_name }}"

    - name: Create as config
      as_config:
        scaling_configuration_name: "{{ config_name }}"
        key_name: "{{ key_name }}"
        image: "Standard_Debian_9_latest"
        flavor: "c4.2xlarge.2"
        disk:
          - size: 10
            volume_type: 'SAS'
            disk_type: 'SYS'
      register: as_config

    - name: assert result
      assert:
        that:
          - as_config is changed
          - as_config is success

    - name: Delete as config
      as_config:
        scaling_configuration_name: "{{ config_name }}"
        state: absent
      register: dropped_as_config

    - name: assert result
      assert:
        that:
          - dropped_as_config is success
          - dropped_as_config is changed


    - name: Delete keypair
      openstack.cloud.os_keypair:
          name: "{{ key_name }}"
          state: absent
